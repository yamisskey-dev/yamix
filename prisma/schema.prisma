generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Misskey/Mastodon instance information
// ============================================
model Server {
  id           String   @id @default(cuid())
  instances    String   @unique
  instanceType String   // misskey, cherrypick, mastodon, etc.
  appSecret    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users User[]

  @@map("servers")
}

// ============================================
// User account (Misskey-linked)
// ============================================
model User {
  id        String   @id @default(cuid())
  handle    String   @unique // @username@instance.tld
  account   String   // username only
  hostName  String   // instance hostname
  token     String   // Encrypted access token
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 将来用: YAMI DAO連携
  ethAddress String? @unique // Optimismアドレス

  // Relations
  serverId      String
  server        Server        @relation(fields: [serverId], references: [id])
  profile       Profile?
  wallet        Wallet?         // 1:1 relation - one user has one wallet
  chatSessions  ChatSession[]   // AI相談セッション
  chatResponses ChatMessage[]   @relation("ChatResponses") // 人間として回答したメッセージ
  blockedBy     UserBlock[]     @relation("BlockedUser") // このユーザーをブロックしている人
  blocking      UserBlock[]     @relation("BlockingUser") // このユーザーがブロックしている人
  notifications Notification[]  // 通知
  bookmarks     Bookmark[]      // ブックマーク
  directedTargets ChatSessionTarget[] @relation("DirectedTargets") // 指名相談の対象

  @@map("users")
}

// ============================================
// User profile information
// ============================================
model Profile {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName          String?
  avatarUrl            String?
  allowDirectedConsult Boolean  @default(false) // 指名相談を受け付けるか（デフォルト: 拒否）
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("profiles")
}

// ============================================
// Wallet - 承認経済（Validation Economy）のトークン口座
// 1 User = 1 Wallet（1対1）
// 詳細: docs/TOKEN_ECONOMY.md
// ============================================
model Wallet {
  id               String     @id @default(cuid())
  address          String     @unique // 公開用ウォレットアドレス（0x形式）
  balance          Int        @default(10) // トークン残高（初期値）
  walletType       WalletType @default(HUMAN) // 人格タイプ
  lastDailyGrantAt DateTime?  // 最後に毎日のBI付与を受け取った日時
  lastDecayAt      DateTime?  // 最後に減衰が適用された日時
  createdAt        DateTime   @default(now())

  // Misskeyユーザーとの紐づけ（1:1必須）
  userId String   @unique
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 将来のDAO連携用（任意）
  daoAddress String? @unique // Optimismアドレス（YAMI DAO連携時に使用）

  // Relations
  posts            Post[]
  sentTransactions Transaction[]   @relation("sender")
  purchases        TokenPurchase[]   // 将来用: DAO連携
  withdrawals      TokenWithdrawal[] // 将来用: DAO連携

  @@index([walletType])
  @@map("wallets")
}

// 人格タイプ（コスト計算に影響）
enum WalletType {
  HUMAN      // 人間ユーザー
  AI_SYSTEM  // AIシステム（Yamii等）
  AI_AGENT   // ユーザー所有のAIエージェント
  DAO        // DAO運営アカウント
}

// ============================================
// Follow - DEPRECATED: フォロー機能は廃止予定
// ブラキャニ風の発見型タイムラインに移行
// ============================================
// model Follow {
//   削除: 相談の二層構造実装に伴い、フォロー機能を廃止
// }

// ============================================
// Post - 相談（反応も相談として扱う）
// 投稿と返信の階層構造
// ============================================
model Post {
  id           String         @id @default(cuid())
  content      String         @db.Text
  walletId     String
  parentId     String?        // 返信の場合、親投稿のID
  postType     PostType       @default(CONSULTATION) // 投稿タイプ
  targetType   ConsultTarget? // 相談対象（AI/人間）
  tokenCost    Int            @default(0) // この投稿で消費されたトークン
  tokenReward  Int            @default(0) // この投稿で獲得したトークン
  createdAt    DateTime       @default(now())

  // Relations
  wallet       Wallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)
  parent       Post?         @relation("PostReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Post[]        @relation("PostReplies")
  transactions Transaction[]

  @@index([walletId])
  @@index([parentId])
  @@index([createdAt])
  @@index([postType])
  @@map("posts")
}

// 投稿タイプ
enum PostType {
  CONSULTATION  // 相談（トークン消費）
  RESPONSE      // 回答（トークン獲得）
  DISCUSSION    // 一般投稿（低コスト）
}

// 相談対象
enum ConsultTarget {
  AI      // AI相談（低コスト）
  HUMAN   // 人間相談（高コスト）
  ANY     // どちらでも可（中コスト）
}

// ============================================
// Transaction - トークン移動記録
// 承認経済における相談・回答・BI付与・減衰の記録
// ============================================
model Transaction {
  id        String          @id @default(cuid())
  postId    String?         // 投稿に紐づく場合
  senderId  String
  amount    Int             @default(1)
  txType    TransactionType @default(REACTION)
  createdAt DateTime        @default(now())

  // Relations
  post   Post?  @relation(fields: [postId], references: [id], onDelete: Cascade)
  sender Wallet @relation("sender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([senderId])
  @@index([txType])
  @@map("transactions")
}

// トランザクションタイプ（承認経済）
enum TransactionType {
  // 承認経済の基本操作
  CONSULT_AI       // AI相談コスト
  CONSULT_HUMAN    // 人間相談コスト
  RESPONSE_COST    // 回答コスト（スパム防止）
  RESPONSE_REWARD  // 回答報酬
  BOOST_BONUS      // ブーストボーナス
  GAS_TIP          // 灯（ともしび）を送る（感謝の追加報酬）
  DAILY_GRANT      // 毎日のBI付与
  DECAY            // 減衰（時間経過による減少）
  REACTION         // リアクション（投げ銭）
  SYSTEM_GRANT     // システム付与（初期配布等）

  // 将来用: DAO連携
  PURCHASE         // Optimism ETHでトークン購入
  WITHDRAWAL       // トークンをOptimism ETHに換金
  DAO_DIVIDEND     // YAMI DAO配当
}

// ============================================
// TokenPurchase - トークン購入（将来用: DAO連携）
// Optimism ETHでトークンを購入
// 現在は未使用、YAMI DAO連携時に有効化
// ============================================
model TokenPurchase {
  id            String         @id @default(cuid())
  walletId      String
  amount        Int            // 購入YAMI数
  ethAmount     String         // 支払いOptimism ETH額（Wei単位、文字列で保存）
  txHash        String?        // Optimismトランザクションハッシュ
  status        PurchaseStatus @default(PENDING)
  createdAt     DateTime       @default(now())
  confirmedAt   DateTime?

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([status])
  @@map("token_purchases")
}

// ============================================
// TokenWithdrawal - トークン換金（将来用: DAO連携）
// トークンをOptimism ETHに換金
// 現在は未使用、YAMI DAO連携時に有効化
// ============================================
model TokenWithdrawal {
  id            String            @id @default(cuid())
  walletId      String
  amount        Int               // 換金YAMI数
  ethAmount     String            // 受取Optimism ETH額（Wei単位）
  ethAddress    String            // 送金先Optimismアドレス
  txHash        String?           // Optimismトランザクションハッシュ
  status        WithdrawalStatus  @default(PENDING)
  createdAt     DateTime          @default(now())
  processedAt   DateTime?

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([status])
  @@map("token_withdrawals")
}

enum PurchaseStatus {
  PENDING    // 支払い待ち
  CONFIRMED  // 確認済み
  FAILED     // 失敗
}

enum WithdrawalStatus {
  PENDING    // 処理待ち
  PROCESSING // 処理中
  COMPLETED  // 完了
  FAILED     // 失敗
}

// ============================================
// EconomyConfig - 承認経済パラメータ設定
// BI付与量、減衰率、相談コスト等の設定
// 将来的にYAMI DAO投票で変更可能
// ============================================
model EconomyConfig {
  id                    String   @id @default(cuid())
  key                   String   @unique
  value                 Int
  description           String?
  updatedAt             DateTime @updatedAt
  updatedByDaoProposal  String?  // 将来用: DAO提案ID

  @@map("economy_config")
}

// 相談タイプ（三層構造）
enum ConsultType {
  PRIVATE   // プライベート相談（AI専用、非公開、1 YAMI）
  PUBLIC    // 公開相談（誰でも回答可能、タイムライン表示、3 YAMI）
  DIRECTED  // 指名相談（指名されたユーザーのみ回答可能、3 YAMI）
}

// ============================================
// UserBlock - ユーザーブロック機能
// Phase 2-3: 悪用防止のためのブロック機能
// ============================================
model UserBlock {
  id         String   @id @default(cuid())
  blockerId  String   // ブロックする人（相談者）
  blockedId  String   // ブロックされる人（回答者）
  createdAt  DateTime @default(now())

  // Relations
  blocker User @relation("BlockingUser", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("BlockedUser", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("user_blocks")
}

// ============================================
// ChatSession - 相談セッション（二層構造）
// PRIVATE: AI専用、非公開（1 YAMI）
// PUBLIC: 誰でも回答可能、タイムライン表示（3 YAMI）
// ============================================
model ChatSession {
  id                       String      @id @default(cuid())
  userId                   String
  title                    String?     // 最初のメッセージから自動生成
  consultType              ConsultType @default(PRIVATE) // 相談タイプ
  isAnonymous              Boolean     @default(false)    // 匿名投稿
  allowAnonymousResponses  Boolean     @default(true)     // 匿名回答を許可するか
  category                 String?                        // Phase 2用: カテゴリ（恋愛/仕事/メンタル等）
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt

  // Backward compatibility
  isPublic Boolean @default(false) // DEPRECATED: consultType=PUBLIC と同義

  // Relations
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]
  bookmarks Bookmark[]    // このセッションをブックマークしているユーザー
  targets   ChatSessionTarget[] // 指名相談の対象ユーザー

  @@index([userId, updatedAt])
  @@index([consultType, createdAt])
  @@index([category])
  @@map("chat_sessions")
}

// ============================================
// ChatSessionTarget - 指名相談の対象ユーザー（多対多）
// DIRECTED相談で指名されたユーザーを管理
// ============================================
model ChatSessionTarget {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User        @relation("DirectedTargets", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([userId])
  @@map("chat_session_targets")
}

// ============================================
// ChatMessage - チャットメッセージ
// セッション内の個別メッセージ（質問・AI回答・人間回答）
// ============================================
model ChatMessage {
  id          String      @id @default(cuid())
  sessionId   String
  role        MessageRole @default(USER)
  content     String      @db.Text
  isCrisis    Boolean     @default(false) // 危機検出フラグ
  isHidden    Boolean     @default(false) // モデレーションにより非表示
  responderId String?     // 人間が回答した場合の回答者ID
  isAnonymous Boolean     @default(false) // 匿名回答
  gasAmount   Int         @default(0)     // 受け取った灯（ともしび）の合計
  createdAt   DateTime    @default(now())

  // Relations
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  responder User?       @relation("ChatResponses", fields: [responderId], references: [id], onDelete: SetNull)

  @@index([sessionId, createdAt])
  @@index([responderId])
  @@map("chat_messages")
}

// ============================================
// Notification - 通知
// ユーザーへの通知（回答、メンション、Gas受信など）
// ============================================
model Notification {
  id        String           @id @default(cuid())
  userId    String           // 通知の受信者
  type      NotificationType // 通知の種類
  title     String           // 通知タイトル
  message   String           // 通知本文
  linkUrl   String?          // 通知をクリックした際のリンク
  isRead    Boolean          @default(false) // 既読フラグ
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

// 通知の種類
enum NotificationType {
  RESPONSE       // 相談への回答
  MENTION        // メンション
  GAS_RECEIVED   // Gas受信
  SYSTEM         // システム通知
}

// ============================================
// Bookmark - ブックマーク
// 気に入った相談セッションを保存して後で振り返る
// ============================================
model Bookmark {
  id        String   @id @default(cuid())
  userId    String   // ブックマークした人
  sessionId String   // ブックマークされたセッション
  createdAt DateTime @default(now())

  // Relations
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId]) // 同じセッションは1回だけブックマーク可能
  @@index([userId, createdAt])
  @@map("bookmarks")
}

// メッセージの送信者
enum MessageRole {
  USER
  ASSISTANT
}
